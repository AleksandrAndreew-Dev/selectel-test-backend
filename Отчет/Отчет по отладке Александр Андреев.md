# Отчёт по отладке FastAPI приложения: Selectel Vacancies Parser

**ФИО:** Александр Андреев

---

### 1. Шаг 1: Анализ, настройка и запуск

- **Что сделано:** Запуск через `docker-compose up`.
- **Проблема:** Контейнер не стартовал из-за некорректной версии FastAPI (`999.0.0`) в `requirements.txt`, несоответствия версий Python и опечатки в `config.py` (`DATABSE_URL`).
- **Решение:** Исправлены версии пакетов, внедрён менеджер зависимостей **uv**, синхронизированы переменные окружения для доступа к PostgreSQL.

---

### 2. Шаг 2: Исправление бага №1 (Фоновый парсинг)

- **Описание проблемы:** Процесс парсинга падал с ошибкой `AttributeError`.
- **Техническое обоснование:** В файле `external.py` поле `city` помечено как `Optional[ExternalCity]`. При попытке вызвать `item.city.name` в парсере, если город не указан (`None`), приложение падало.
- **Файл:** `app/services/parser.py`.
- **Решение:** Добавлена проверка:
```python
"city_name": item.city.name.strip() if item.city else None
```

---

### 3. Шаг 3: Исправление бага №2 (Расписание парсинга)

- **Описание проблемы:** Парсинг запускался каждые 5 секунд вместо положенных 5 минут.
- **Файл:** `app/core/scheduler.py`.
- **Причина:** В методе `add_job` планировщика `APScheduler` вместо минут ошибочно использовались секунды (`seconds=settings.parse_schedule_minutes`).
- **Решение:** Изменён аргумент на `minutes=` или добавлена конвертация в секунды (`* 60`).

---

### 4. Шаг 4: Исправление бага №3 (Производительность БД)

- **Описание проблемы:** Проблема **N+1** при синхронизации вакансий.
- **Техническое обоснование:** Модель `Vacancy` (файл `vacancy.py`) имеет `UniqueConstraint` на `external_id`. При обновлении большого списка вакансий по одной записи создавалось избыточное количество SQL-запросов.
- **Решение:** Реализована пакетная выборка вакансий через `.in_(external_ids)` и обновление через маппинг в памяти.

---

### 5. Шаг 5: Исправление бага №4 (Утечка ресурсов в парсере)

- **Описание проблемы:** Накопление открытых TCP-соединений.
- **Файл:** `app/services/parser.py`.
- **Причина:** `httpx.AsyncClient` не закрывался явно после итерации.
- **Решение:** Внедрено использование контекстного менеджера:
```python
async with httpx.AsyncClient() as client:
    ...
```

---

### 6. Шаг 6: Исправление бага №5 (Обработка дубликатов в API)

- **Описание проблемы:** При создании вакансии с существующим `external_id` сервер возвращал `200 OK`.
- **Файл:** `app/api/v1/vacancies.py`.
- **Решение:** Вместо ручного формирования `JSONResponse` теперь выбрасывается исключение:
```python
raise HTTPException(status_code=409, detail="Vacancy with external_id already exists")
```
Это позволяет FastAPI корректно обрабатывать `response_model`.

---

### 7. Шаг 7: Исправление бага №6 (Работа с датами и часовыми поясами)

- **Описание проблемы:** Даты теряли информацию о часовом поясе или возвращались в нечитаемом формате.
- **Техническое обоснование:** В модели `Vacancy` (файл `vacancy.py`) используется `DateTime(timezone=True)`.
- **Решение:**
  - В файле `sch-vacancy.py` в схемах настроен `json_encoders` для формата `%Y-%m-%d %H:%M:%S`.
  - Внедрён валидатор `ensure_utc`, который принудительно устанавливает `timezone.utc` для объектов без смещения.

---

### 8. Шаг 8: Исправление бага №7 (Гибкость CRUD и именование)

- **Описание проблемы:** Ошибка фильтрации вакансий (`city` vs `city_name`) и невозможность частичного обновления через `PUT`.
- **Файлы:** `schemas/vacancy.py` и `crud/vacancy.py`.
- **Решение:**
  - Синхронизировано имя аргумента `city_name` между эндпоинтом и логикой CRUD.
  - В схеме `VacancyUpdate` все поля сделаны `Optional`, что позволило реализовать частичное обновление (PATCH-подобное поведение в PUT).

---

### 9. Шаг 9: Исправление бага №8 (Отказоустойчивость Startup)

- **Описание проблемы:** При ошибке внешнего API или сети во время старта парсинга (`startup`) всё приложение не запускалось.
- **Файл:** `app/main.py`.
- **Решение:** Переход на современный `lifespan`-менеджер и обёртка вызова `_run_parse_job` в блок `try/except`. При сбое парсинга приложение продолжает работу, фиксируя ошибку в логах.

---

## Итог

- Исправлено **8 багов**.
- Все CRUD-операции (чтение, добавление, изменение, удаление) работают исправно.
- Фоновая задача выполняется каждые 5 минут.
- Приложение возвращает корректные HTTP-статусы и данные в Swagger UI.

---
