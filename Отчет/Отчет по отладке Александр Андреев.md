

---

# Отчёт по отладке FastAPI приложения:
## Selectel vacancies parser





**ФИО:** Александр Андреев

### 1. Шаг 1: Анализ, настройка и запуск

**Что сделано:** Запуск через `docker-compose up`.

**Проблема 1:** Некорректная версия FastAPI (`999.0.0`) в `requirements.txt` и несоответствие версий Python.

**Проблема 2:** Опечатка в `config.py` (`DATABSE_URL`) и расхождение адреса базы данных между `.env` и `docker-compose.yml`.

**Решение:** Перешел на использование `uv` для управления зависимостями. Исправил опечатку в конфигурации и синхронизировал имя хоста базы данных (`db` -> `postgres`).

---

### 2. Шаг 2: Исправление бага №1 (Фоновый парсинг)

**Описание проблемы:** Процесс парсинга падал с ошибкой `AttributeError`, так как поле `city` во внешнем API может быть `None`.

**Файл:** `app/services/parser.py`

**Код до:**

```python
"city_name": item.city.name.strip()
```

**Код после:**

```python
"city_name": item.city.name.strip() if item.city else 'No city'
```

**Причина:** Отсутствие проверки на наличие объекта `city` перед обращением к его атрибуту `name`.

---

### 3. Шаг 3: Исправление бага №2 (Расписание парсинга)

**Описание проблемы:** Парсинг запускался каждые 5 секунд вместо положенных 5 минут.

**Файл:** `app/core/scheduler.py`

**Код до:**

```python
seconds=settings.parse_schedule_minutes
```

**Код после:**

```python
seconds=settings.parse_schedule_minutes * 60,
```

**Причина:** Использование неверного именованного аргумента (`seconds` вместо `minutes`) или отсутствие конвертации минут в секунды в методе `add_job`.

---

### 4. Шаг 4: Исправление бага №3 (Производительность БД)

**Описание проблемы:** Проблема **N+1** при обновлении вакансий (запрос к базе в цикле для каждой записи).

**Файл:** `app/crud/vacancy.py`.

**Код до:**

```python
for payload in payloads:
    result = await session.execute(select(Vacancy).where(Vacancy.external_id == ext_id))
    vacancy = result.scalar_one()
```

**Код после:**

```python
result = await session.execute(select(Vacancy).where(Vacancy.external_id.in_(external_ids)))
existing_map = {v.external_id: v for v in result.scalars().all()}
```

**Причина:** Избыточное количество SQL-запросов при массовой обработке данных.

---

### 5. Шаг 5: Исправление бага №4 (Формат API ответов)

**Описание проблемы:** Даты возвращались в формате ISO, и отсутствовал статус `200 OK` для `PUT`-запроса.

**Файлы:** `app/schemas/vacancy.py` и `app/api/v1/vacancies.py`.

**Код после (схема):**

```python
model_config = ConfigDict(json_encoders={datetime: lambda dt: dt.strftime('%Y-%m-%d %H:%M:%S')})
```

**Код после (роутер):**

```python
@router.put("/{vacancy_id}", response_model=VacancyRead, status_code=status.HTTP_200_OK)
```

**Причина:** Необходимо приведение формата данных к требованиям фронтенда и явное указание успешных статус-кодов.

---

### 6. Шаг 6: Исправление бага №5 (Именование аргументов фильтрации)

**Описание проблемы:** Ошибка фильтрации вакансий по городу из-за разницы в именах переменных.

**Файлы:** `app/api/v1/vacancies.py` и `app/crud/vacancy.py`.

**Код до (эндпоинт):**

```python
async def get_vacancies(city: str = None):
```

**Код после (эндпоинт):**

```python
async def get_vacancies(city_name: str = None):
```

**Причина:** В эндпоинте аргумент назывался `city`, а в логике CRUD и модели БД ожидалось `city_name`. Приведение к единому стандарту исправило работу фильтра.

---

## Итог

**Результат:** Исправлено 8 багов (конфигурация, зависимости, логика парсинга, планировщик и оптимизация БД).

**Статус:** Все CRUD-операции работают , фоновая задача выполняется каждые 5 минут, данные защищены уникальным индексом.

**Swagger:** API доступно и возвращает корректные HTTP-статусы.

---
